---
title: "Data analysis for WP10"
author: "Patrizia Maier"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=F, cache=F}

library(tidyverse)
library(janitor)
library(gtsummary)
library(rstatix)
library(ggpubr)
library(lme4)
library(nlme)
library(Rcpp)
library(robustlmm)
library(afex)
library(WRS2)
# install.packages('tinytex')
# tinytex::install_tinytex() # latex for pdf file creation

```


```{r load_data, include=F}
file_name <- "../WP10_data/WP10_results/wp10_navigation_data.RData"
load(file_name)
sm_orig <- sm_data 
rm(file_name)

file_name <- "../WP10_data/WP10_results/wp10_post_nav_data.RData"
load(file_name)
rm(file_name)
```


## Demographics 

Available navigation data 

```{r demo_1, echo=F, message=F, warning=F}
t1 <- sm_data %>% 
  filter(trial_num==1, session==1) %>% 
  select(group, sex) %>%
  tbl_summary(by=group,
              label=list(sex ~ "Gender"),
              statistic=list(all_categorical() ~ "{n}")) %>% 
  modify_header(label="Starmaze data",
                stat_by="**{level}** N = {n}") %>% 
  modify_footnote(everything() ~ NA)
t1
rm(t1)

# t1 %>%
#   as_flex_table() %>%
#   flextable::save_as_docx(path="TEST.docx")
```
 
Available post-navigation data 
 
```{r demo_2, echo=F, message=F, warning=F}
t2 <- pt_data %>% 
  filter(trial_num==1) %>% 
  select(group, sex) %>%
  tbl_summary(by=group,
              label=list(sex ~ "Gender"),
              statistic=list(all_categorical() ~ "{n}")) %>% 
  modify_header(label="Post-navigation data",
                stat_by="**{level}** N = {n}") %>% 
  modify_footnote(everything() ~ NA)
t2
rm(t2)
```

```{r stats_correct1}
data <- sm_data %>%
  filter(exclude_trial_matlab==0) %>% 
  filter(condition %in% c("allo_ret", "ego_ret"))


# mglmer.gsci <- glmer(correct_final_alley ~ 1 + group*session*condition +
#                   (1 + session|id) + (1 + condition|id), data=data, family=binomial)
# all_fit(mglmer.gsci)
# # chose bobyqa as optimizer


mglmer.red <- glmer(correct_final_alley ~ 1 + (1 + session|id) + (1 + condition|id),
                   data=data, family=binomial, control=glmerControl(optimizer="bobyqa"))

mglmer.g <- glmer(correct_final_alley ~ 1 + group +
                  (1 + session|id) + (1 + condition|id),
                data=data, family=binomial, control=glmerControl(optimizer="bobyqa"))

mglmer.gs <- glmer(correct_final_alley ~ 1 + group + session +
                  (1 + session|id) + (1 + condition|id),
                data=data, family=binomial, control=glmerControl(optimizer="bobyqa"))

mglmer.gsi <- glmer(correct_final_alley ~ 1 + group*session +
                  (1 + session|id) + (1 + condition|id),
                data=data, family=binomial, control=glmerControl(optimizer="bobyqa"))

mglmer.gc <- glmer(correct_final_alley ~ 1 + group + condition +
                  (1 + session|id) + (1 + condition|id),
                data=data, family=binomial, control=glmerControl(optimizer="bobyqa"))

mglmer.gci <- glmer(correct_final_alley ~ 1 + group*condition +
                  (1 + session|id) + (1 + condition|id),
                data=data, family=binomial, control=glmerControl(optimizer="bobyqa"))

mglmer.gsc <- glmer(correct_final_alley ~ 1 + group + session + condition +
                  (1 + session|id) + (1 + condition|id),
                data=data, family=binomial, control=glmerControl(optimizer="bobyqa"))

mglmer.gsci <- glmer(correct_final_alley ~ 1 + group*session*condition +
                  (1 + session|id) + (1 + condition|id), data=data, family=binomial,
                  control=glmerControl(optimizer="bobyqa"))
```

```{r stats_correct2}
# likelihood ratio comparison for model selection

# anova(mglmer.red, mglmer.g, mglmer.gs, mglmer.gsi) # best model: gs
# 
# anova(mglmer.red, mglmer.g, mglmer.gc, mglmer.gci) # best model: g
# 
# anova(mglmer.gs, mglmer.gsc, mglmer.gsi) # best model: gs

# best model: group and session, no interaction
summary(mglmer.gs)

# question: do we need to remove (1 + condition|id)?
```

```{r stats_correct3}
# alternative approach: mixed() from afex()
mixed(correct_final_alley ~ 1 + group*session*condition +
                  (1 + session|id) + (1 + condition|id),
                data=data, family=binomial, control=glmerControl(optimizer="bobyqa"),
      method="LRT")

# model: group and session are significant 
```

```{r stats_path1}

# normal lmer model selection
mlmer.red <- lmer(path_distance ~ 1 + (1|id), data=data, REML=F)

mlmer.s <- lmer(path_distance ~ 1 + session + (1|id), data=data, REML=F)

mlmer.srs <- lmer(path_distance ~ 1 + session + (session|id), data=data, REML=F)

anova(mlmer.red, mlmer.s, mlmer.srs)


mlmer.c <- lmer(path_distance ~ 1 + condition + (1|id), data=data, REML=F)

mlmer.crs <- lmer(path_distance ~ 1 + condition + (condition|id), data=data, REML=F)

anova(mlmer.red, mlmer.c, mlmer.crs)


mlmer.g <- lmer(path_distance ~ 1 + group + (1|id), data=data, REML=F)

anova(mlmer.red, mlmer.g)


mlmer.gcs <- lmer(path_distance ~ 1 + group + session + condition + 
                    (1 + session + condition|id), data=data, REML=F)

mlmer.gcsi <- lmer(path_distance ~ 1 + group*session*condition + 
                    (1 + session + condition|id), data=data, REML=F)

anova(mlmer.red, mlmer.gcs, mlmer.gcsi)

```

```{r stats_path2}
# alternative approach: mixed() from afex
mixed(path_distance ~ 1 + group*session*condition + 
                    (1 + session + condition|id), data=data, method="LRT")

# compare 
summary(mlmer.gcsi)
```

```{r stats_path2}

# check robustness with rlmer() # TBD check this
mrlmer.gcsi <- rlmer(path_distance ~ 1 + group*session*condition + 
                       (1 + session|id) + (1 + condition|id), data=data, REML=F)

summary(mrlmer.gcsi)
```


```{r stats_layout}

data <- pt_data %>% 
  filter(condition=="layout")

fisher.test(table(data$score, data$group))
pairwise_fisher_test(table(data$score, data$group), p.adjust.method="bonferroni")

```

```{r stats_gmda}

data <- pt_data %>% 
  filter(condition=="position")

# ### histogramm
# ggplot(data, aes(x=score)) +
#   geom_histogram(binwidth=0.1) + 
#   facet_wrap(~group)
#   
# ### normality
# data %>% group_by(group, session) %>% shapiro_test(score)
# ggqqplot(data, "score", ggtheme = theme_bw()) + facet_grid(~group)
# 
# ### homoscedasticity
# data %>% levene_test(score ~ group)

### ANOVA
summary(aov(score ~ group, data=data))
pairwise.t.test(data$score, data$group, p.adjust.method="bonferroni")
performance::r2(aov(score ~ group, data=data))

### robust ANOVA (WSR2)
t1waybt(score ~ group, data=data, tr=0.2, nboot=2000)
mcppb20(score ~ group, data=data, tr=0.2, nboot=2000)

### Kruskal-Wallis test 
kruskal.test(score ~ group, data=data)
dunn_test(score ~ group, data=data, p.adjust.method="bonferroni")

```

```{r stats_lm}
data <- pt_data %>% 
  filter(condition=="landmarks")

# ### histogramm
# ggplot(data, aes(x=score)) +
#   geom_histogram(binwidth=0.1) +
#   facet_wrap(~group)
# 
# ### normality
# data %>% group_by(group, session) %>% shapiro_test(score)
# ggqqplot(data, "score", ggtheme = theme_bw()) + facet_grid(~group)
# 
# ### homoscedasticity
# data %>% levene_test(score ~ group)

### ANOVA
summary(aov(score ~ group, data=data))
pairwise.t.test(data$score, data$group, p.adjust.method="bonferroni")
performance::r2(aov(score ~ group, data=data))

### robust ANOVA (WSR2)
t1waybt(score ~ group, data=data, tr=0.2, nboot=2000)
#mcppb20(score ~ group, data=data, tr=0.2, nboot=2000)

### Kruskal-Wallis test
kruskal.test(score ~ group, data=data)
dunn_test(score ~ group, data=data, p.adjust.method="bonferroni")

```

```{r stats_go}

data <- pt_data %>% 
  filter(condition=="goals")

# ### histogramm
# ggplot(data, aes(x=score)) +
#   geom_histogram(binwidth=0.1) + 
#   facet_wrap(~group)
#   
# ### normality
# data %>% group_by(group, session) %>% shapiro_test(score)
# ggqqplot(data, "score", ggtheme = theme_bw()) + facet_grid(~group)
# 
# ### homoscedasticity
# data %>% levene_test(score ~ group)

### ANOVA
summary(aov(score ~ group, data=data))
performance::r2(aov(score ~ group, data=data))

### robust ANOVA (WSR2)
t1waybt(score ~ group, data=data, tr=0.2, nboot=2000)

### Kruskal-Wallis test
kruskal.test(score ~ group, data=data)

```