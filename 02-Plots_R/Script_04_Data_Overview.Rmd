---
title: "Analysis Overview for WP10 Starmaze Data"
author: "Patrizia Maier"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
    fig_caption: yes
    global_numbering: TRUE
    number_sections: TRUE
---

# Task

Navigating a star-shaped maze environment ("Starmaze") with three goal locations.

![Map of the environment](./pics/Starmaze_Environment.jpg){width=400px}

# Sessions

*Day 2*

* Practise trials: joystick control (2 trials) and task explanation (5 trials).
* Navigation to and remembering of three goal locations. Training trials where goal is visible. Probe trials where goal is not visible with two conditions: egocentric (observer-dependent, i.e. from same starting point but without landmark cues) and allocentric (observer-independent, i.e. from new starting points) (15 trials * 3 goal locations = 45 trials).

*Day 14*

* Egocentric and allocentric probe trials (4 trials * 3 locations = 12 trials (plus 3 * simple probe trials which are not analyzed)).
* Non-navigation memory test: Recognize maze shape, recognize landmarks and goal objects, position landmarks and goal object (4 trials).

![Example view from task](./pics/Starmaze_01.png){width=500px}

![Trial order at Day 2 (45 trials)](./pics/Overview_Session1.jpg){width=500px}

![Trial order at Day 14 (15 trials)](./pics/Overview_Session2.jpg){width=500px}


```{r setup, include=FALSE, cache=FALSE}
knitr::read_chunk('Script_02_Analyzer.R')
knitr::opts_chunk$set(warning=FALSE, message=FALSE) 
```

```{r, load_analysis_packages, include=FALSE, cache=FALSE}
```

```{r, include=FALSE}
file_name <- "../WP10_data/WP10_results/wp10_navigation_data.RData"
load(file_name)
sm_orig <- sm_data 
sm_data <- sm_data %>% filter(exclude_trial_matlab==0)
rm(file_name)

nn_YK <- length(unique(sm_data$id[sm_data$group=="YoungKids"]))
nn_OK <- length(unique(sm_data$id[sm_data$group=="OldKids"]))
nn_AD <- length(unique(sm_data$id[sm_data$group=="YoungAdults"]))

file_name <- "../WP10_data/WP10_results/wp10_post_nav_data.RData"
load(file_name)
rm(file_name)

np_YK <- length(unique(pt_data$id[pt_data$group=="YoungKids"]))
np_OK <- length(unique(pt_data$id[pt_data$group=="OldKids"]))
np_AD <- length(unique(pt_data$id[pt_data$group=="YoungAdults"]))
```

```{r, data_prep, include=FALSE}
```

```{r, plot_settings, include=FALSE}
```

```{r, analysis_settings, include=FALSE}
```

# Sample
Cross-sectional comparison between

* Young kids (6-7 yrs, n = `r nn_YK`, non-navigational n = `r np_YK`) 
* Older kids (9-10 yrs, n = `r nn_OK`, non-navigational n = `r np_OK`)
* Young adults (18-35 yrs, n = `r nn_AD`, non-navigational n = `r np_AD`)

# Variables of interest

In training trials, the goal is visible, i.e. the trial is always completed successfully. In probe trials, the goal is not visible. Participants go to the place where they remember the goal being located and press a button. 

*Memory accuracy*: 

* **Memory score** (metric): Euclidean distance between x-/y-coordinates of the chosen and the correct goal location. Memory score normalizes the Euclidean distance value as a score from 0 to 1 (chance level 0.5) by comparing final distance to the final distance of 1000 randomly sampled and uniformly distributed locations in the maze (Jacobs 2016; Bellmund 2019)
$$\text{Euclidean distance} = \sqrt{(x_{correct}-x_{chosen})^2 + (y_{correct}-y_{chosen})^2}$$
$$\text{Memory score} = 1 - \text{percentage of random Euclidean distance values that are smaller than Euclidean distance}$$
* **Correct trial** (yes/no): Finding the correct goal alley, defined as the correct outer alley or intersection right in front.

*Navigation behavior*: 

* **Time**: Time to complete the trial in seconds.
* **Excess path length** (metric): The travelled path length minus the ideal path length to the chosen location. The path lengths are calculated as summation of Euclidean distances between x-/y-coordinates over time (Suthana 2012; Jacobs 2016; Bellmund 2019)
$$\text{(Ideal) path length} = \sum \sqrt{(x_{t}-x_{t+1})^2 + (y_{t}-y_{t+1})^2}$$
$$\text{Excess path length} = (path-path_{ideal})$$
* **Presence in zone** (metric): Proportion of time/data points spend in a defined zone (tbd: add reference Water maze literature). 
$$\text{Presence in zone} = \frac {n(xy_{zone})} {n(xy)} $$
* **Rotation**: The sum of absolute z-rotations over time divided by 360° (i.e. full turns; the calculation takes into account the switch at 0/360°). Variants of this measure are 1. Rotation in the initial area (start alley plus first intersecion), 2. Rotation normalized by path length (because longer paths automatically involve more rotation in the Starmaze environment). This measure is supposed to reflect intentional visual exploration. 
$$\text{Rotation in initial area} = \frac {\sum |(z_{t}-z_{t+1})|} {360} $$
$$\text{Rotation by path length} = \frac {\sum |(z_{t}-z_{t+1})|} {path} * \frac {1} {360} $$

![Visualization of variables of interest](./pics/Var_all.jpg){width=300px,height=500x}

# Statistical analysis

All linear mixed models (LMM) were computed using the mixed() function from the afex package (Singmann et al., 2022), which is based on lmer() from the lme4 package (Bates et al., 2015). The random effects structure was set up according to Bates et al. (2015) and Matuschek et al. (2017). The diagnostic plots showed non-normality, outliers and heteroscedastic variances (especially larger variance in children compared to adults). To account for this, we computed additional models 1. excluding outliers (defined as above/below the upper/lower quantile plus/minus 1.5 * IQR, similar to Bellmund et al., 2019) and 2. models with heterogeneous variances with lme() from the nlme package (Pinheiro & Bates, 2022). The results did not change substantially, which is why we decided to use the most simple LMM approach. 

For evaluating the general fit, we calculated a (pseudo) R^2^ for each model according to Nakagawa and Schielzeth's (2013) approach with the r2beta() function from the r2glmm package (Jaeger, 2017). However, R^2^ for LMM should be interpreted with caution and do not directly correspond to a traditional R^2^. We computed degrees of freedom for the LMM with Sattherthwaites method using the lmerTest package (Kuznetsova et al., 2017; via afex package). For all significant main effects and interactions, we computed post-hoc planned contrasts with the emmeans package (Lenth, 2022), using Bonferroni-corrections for multiple comparisons.

Single-trial values were analyzed with ANOVAs from the afex package (Singmann et al., 2022). 

\newpage

# Results 

## Memory accuracy: Probe trials at Day 2 & Day 14

```{r, dot_plots, include=F }

dot_plots <- function(mydata, xvar, yvar, goalvar, goalx, goaly, mytitle, 
                      mylabels, facetr="session", facetc="group") {
  p <- ggplot(mydata, aes(x=get(xvar), y=get(yvar), shape=get(goalvar))) + 
    geom_point(aes(color=get(goalvar)), size=1.5) +
    geom_point(aes(x=get(goalx), y=get(goaly), fill=get(goalvar), shape=get(goalvar)), size=4) +
    scale_shape_manual(values=c(21, 22, 24)) +
    scale_fill_brewer(palette="Set2") + 
    scale_color_brewer(palette="Set2") + 
    scale_x_continuous(breaks=c(0, 0.5, 1), labels=c(0, 0.5, 1)) + 
    scale_y_continuous(breaks=c(0, 0.5, 1), labels=c(0, 0.5, 1)) + 
    coord_fixed(ratio=1, xlim=c(0, 1), ylim=c(0, 1), expand=TRUE, clip="on") +
    facet_grid(formula(paste(facetr, "~", facetc))) +  
    theme_bw() +
    theme(legend.position="top",
          legend.key.size=unit(0.25, 'cm'),
          legend.justification=c(0, 0),
          legend.title=element_blank()) + 
    labs(title=mytitle,
         subtitle="Remembered goal location for goals 1-3",
         x="x",
         y="y")
  
  return(p)
}

dots_ego <- dot_plots(data_p %>% filter(condition=="ego_ret"), "x_n", "y_n", 
                      "cov_location", "goal_x", "goal_y", "Egocentric trials", mylabels)

dots_allo <- dot_plots(data_p %>% filter(condition=="allo_ret"), "x_n", "y_n", 
                       "cov_location", "goal_x", "goal_y", "Allocentric trials", mylabels)

rm(dot_plots)
```

```{r,echo=F, fig.height=5, fig.cap="Responses for egocentric probe." }

dots_ego 
rm(dots_ego)
```

```{r,echo=F, fig.height=5, fig.cap="Responses for allocentric probe." }

dots_allo 
rm(dots_allo)
```

\newpage 

### **Memory score (all probe trials)**

```{r, model_probe_ms }
```

```{r, plot_probe_ms, include=F }
```

```{r, echo=F, fig.height=5, fig.width=5, fig.cap="Memory score for probe trials." }
plot.ms
rm(plot.ms)
```

```{r apa_probe_ms, include=F}
R2 <- r2beta(model.ms$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(model.ms)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

emm1 <- emmeans(model.ms$full_model, pairwise ~ group, lmer.df="satterthwaite", adjust="bonferroni")$contrasts
apa_emm1 <- apa_print(emm1)
apa_emm1 <- apa_emm1$table %>% remove_rownames()
rm(emm1)

# # test against chance level 
# emm <- emmeans(model.ms, ~ group*condition*session, lmer.df="satterthwaite")
# summary(emm, null=0.5, adjust="bonferroni", infer=c(T,T))

rm(emm1)
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

* *group* main effect: age-related differences in memory performance. 
* *session* main effect: memory accuracy declines over 2-week period.
* *condition* main effect: egocentric slightly better than allocentric. 
* no *group x condition* interaction, i.e. no age-specific condition differences.
* no *group x session* interaction, i.e. similar forgetting for all groups. 
* no *session x condition* interaction, i.e. similar forgetting for both conditions. 
(Table\ \@ref(tab:table-probe-ms0)). 

(ref:p-ms-caption0) Fixed effects for memory score in probe.

```{r table-probe-ms0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:p-ms-caption0)",
  placement="h")
```

(ref:p-ms-caption1) Post-hoc contrasts for factor group.

```{r table-probe-ms1, echo=F}
apa_table(
  apa_emm1,
  caption="(ref:p-ms-caption1)",
  placement="h")
```

```{r, include=F}
rm(probe.memory_s, R2, apa_lmm, apa_emm1)
```

\newpage

## Memory accuracy: Non-navigational memory tasks at Day 14

![Task overview](./pics/Overview_Session2_PostTest.jpg){width=500px}

```{r, model_post_layout, include=F }
```

```{r, plot_post_layout, include=F }

# detailed 
layout_data <- pt_data %>% 
  filter(condition=="layout") %>% 
  filter(!is.na(layout_obj_1)) %>% 
  select(id, group, layout_obj_1) %>% 
  group_by(group) %>% 
  count(layout_obj_1) %>% 
  mutate(n_per_group=sum(n),
         perc=n/n_per_group)

plot.layout_detailed <- ggplot(layout_data, aes(x=group, y=perc, fill=layout_obj_1)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  scale_x_discrete(labels=group_labels) + 
  scale_fill_brewer(palette="Pastel1", direction=-1, name=NULL) + 
  coord_cartesian(ylim=c(0,1)) +
  theme_bw(base_size=15) +
  theme(legend.position="top", legend.justification=c(0,0),
        legend.title=NULL, 
        panel.grid.major.x=element_blank()) +
  labs(x=NULL, y="responses (%)")
rm(layout_data)

# averaged 
plot.layout <- ggplot(pt_data %>% filter(condition=="layout"), 
                      aes(x=group, y=score, shape=group, color=group)) + 
  geom_point(position=position_jitter(h=0, seed=100), color="darkgrey") + 
  stat_summary(fun=mean, na.rm=T, geom="point", size=5) + 
  scale_shape_manual(values=c(16, 17, 15), labels=group_labels, name=NULL) + 
  scale_color_manual(values=group_colors, labels=group_labels, name=NULL) + 
  scale_x_discrete(labels=group_labels) + 
  coord_cartesian(ylim=c(0,1)) +
  theme_bw(base_size=15) +
  theme(legend.position="top", legend.justification=c(0,0),
        legend.title=NULL, 
        panel.grid.major.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.x=element_blank()) +
  labs(x=NULL, y="layout accuracy (%)")
```

```{r, model_post_landmark, include=F }
```

```{r, plot_post_landmark, include=F }
```

```{r, model_post_position, include=F }
```

```{r, plot_post_position, include=F }
```

```{r, echo=F, fig.height=5, fig.width=8, fig.cap="Scores in non-navigational memory tests." }
  plot.layout + 
  (plot.landmark + guides(color="none", shape="none")) + 
  (plot.position + guides(color="none", shape="none")) + 
  plot_annotation(title="Non-navigational memory tests") +
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(plot.layout, plot.landmark, plot.position)
```

### **Layout**

Significant age-related *group* differences in layout recognition.

Fisher Test for layout recognition.

```{r table-layout0, echo=F}
model.layout
```

Post-hoc contrasts for factor group.

```{r table-layout1, echo=F}
post.layout
```

### **Landmarks**

```{r apa_landmark, include=F}
apa_aov <- apa_print(model.landmark)
```

No significant age-related *group* differences in landmark recognition.  
(Table\ \@ref(tab:table-lm0)). 

(ref:lm-caption0) ANOVA for landmark recognition.

```{r table-lm0, echo=F}
apa_table(
  apa_aov,
  caption="(ref:lm-caption0)",
  placement="h")
```

```{r, include=F}
rm(landmark_aov, apa_aov)
```

### **Positioning**

```{r apa_gmda, include=F}
apa_aov <- apa_print(model.position)

emm1 <- emmeans(model.position, pairwise ~ group, adjust="bonferroni")$contrasts
apa_emm1 <- apa_print(emm1)
apa_emm1 <- apa_emm1$table %>% remove_rownames()
rm(emm1)
```

Significant age-related *group* differences in positioning.  
(Table\ \@ref(tab:table-gmda0)). 

(ref:gmda-caption0) ANOVA for positioning task.

```{r table-gmda0, echo=F}
apa_table(
  apa_aov,
  caption="(ref:gmda-caption0)",
  placement="h")
```

(ref:gmda-caption1) Post-hoc contrasts for factor group.

```{r table-gmda2, echo=F}
apa_table(
  apa_emm1,
  caption="(ref:gmda-caption0)",
  placement="h")
```

```{r, include=F}
rm(position_aov, apa_aov, apa_emm1)
```

\newpage 

## Navigation behaviour: Probe trials at Day 2 & Day 14

### **Time**

```{r, stats_probe_time_simple}
```

```{r, plot_probe_time, include=F }
```

```{r, echo=F, fig.height=5, fig.width=5, fig.cap="Time in probe trials." }
line_time
rm(line_time)
```

```{r apa_probe_time, include=F}
R2 <- r2beta(probe.time_s$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(probe.time_s)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

emm1 <- emmeans(probe.time_s, ~ group*session, lmer.df="satterthwaite")
con1 <- summary(rbind(pairs(emm1, simple="group"), pairs(emm1, simple="session"), pairs(emm1, interaction="pairwise")), 
                infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm1 <- apa_print(con1)
apa_emm1 <- apa_emm1$table %>% remove_rownames()
rm(emm1, con1)

emm2 <- emmeans(probe.time_s, ~ group*condition, lmer.df="satterthwaite")
con2 <- summary(rbind(pairs(emm2, simple="group"), pairs(emm2, simple="condition")), infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm2 <- apa_print(con2)
apa_emm2 <- apa_emm2$table %>% remove_rownames()
rm(emm2, con2)

emm3 <- emmeans(probe.time_s, ~ session*condition, lmer.df="satterthwaite")
con3 <- summary(rbind(pairs(emm3, simple="session"), pairs(emm3, simple="condition"), pairs(emm3, interaction="pairwise")), 
                infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm3 <- apa_print(con3)
apa_emm3 <- apa_emm3$table %>% remove_rownames()
rm(emm3, con3)
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

* *group x session* interaction: for all groups no significant change of time across sessions (slopes not different from zero); the slopes differed only between 6-7-year-old children (numerical decrease across sessions) and adults (numerical increase across sessions). 
* *group x condition* interaction: all groups required more time for allocentric compared to egocentric trials; in allocentric trials 6-7-year-old children required significantly more time than young adults, in egocentric trials there were no significant group differences. 
* *session x condition* interaction: for both conditions no significant change of time across sessions (slopes not different from zero); the slopes differed between egocentric (numerical decrease across sessions) and allocentric (numerical increase across sessions).
(Table\ \@ref(tab:table-probe-time0)).

(ref:p-t-caption0) Fixed effects for time in probe trials.

```{r table-probe-time0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:p-t-caption0)",
  placement="h")
```

(ref:p-t-caption1) Post-hoc contrasts for group x session interaction.

```{r table-probe-time1, echo=F}
apa_table(
  apa_emm1,
  caption="(ref:p-t-caption1)",
  placement="h")
```

(ref:p-t-caption2) Post-hoc contrasts for group x condition interaction.

```{r table-probe-time2, echo=F}
apa_table(
  apa_emm2,
  caption="(ref:p-t-caption2)",
  placement="h")
```

(ref:p-t-caption3) Post-hoc contrasts for session x condition interaction.

```{r table-probe-time3, echo=F}
apa_table(
  apa_emm3,
  caption="(ref:p-t-caption3)",
  placement="h")
```

```{r, include=F}
rm(probe.time_s, apa_lmm, apa_emm1, apa_emm2, apa_emm3)
```

\newpage 

### **Excess path length**

```{r, stats_probe_excess_path_simple }
```

```{r, plot_probe_excess_time, include=F }
```

```{r, echo=F, fig.height=5, fig.width=5, fig.cap="Excess path in probe trials." }
line_excess_path
rm(line_excess_path)
```

```{r apa_probe_excess_path, include=F}
R2 <- r2beta(probe.excess_path_s$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(probe.excess_path_s)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

emm1 <- emmeans(probe.excess_path_s, ~ group * session, lmer.df="satterthwaite")
con1 <- summary(rbind(pairs(emm1, simple="group"), pairs(emm1, simple="session"), pairs(emm1, interaction="pairwise")), 
                infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm1 <- apa_print(con1)
apa_emm1 <- apa_emm1$table %>% remove_rownames()
rm(emm1, con1)

emm2 <- emmeans(probe.excess_path_s, ~ group * condition, lmer.df="satterthwaite")
con2 <- summary(rbind(pairs(emm2, simple="group"), pairs(emm2, simple="condition")), infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm2 <- apa_print(con2)
apa_emm2 <- apa_emm2$table %>% remove_rownames()
rm(emm2, con2)

emm3 <- emmeans(probe.excess_path_s, ~ session * condition, lmer.df="satterthwaite")
con3 <- summary(rbind(pairs(emm3, simple="session"), pairs(emm3, simple="condition"), pairs(emm3, interaction="pairwise")), 
                infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm3 <- apa_print(con3)
apa_emm3 <- apa_emm3$table %>% remove_rownames()
rm(emm3, con3)
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

* *group x session* interaction: for all groups no significant change of time across sessions (slopes not different from zero); the slopes differed only between 6-7-year-old children (numerical decrease across sessions) and both 9-10-year-old children and adults (numerical increase across sessions).
* *group x condition* interaction: all groups had longer excess paths in allocentric compared to egocentric trials; in allocentric trials both groups of children had significantly longer excess paths than young adults, in egocentric trials only 6-7-year-old children had longer excess paths than young adults. 
* *session x condition* interaction: only for allocentric condition significant change (increase) in excess path length across sessions, but not in egocentric; the slopes differed between egocentric (numerical decrease across sessions) and allocentric (increase across sessions).
(Table\ \@ref(tab:table-probe-excess0)). 

(ref:p-ep-caption0) Fixed effects for excess path in probe trials.

```{r table-probe-excess0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:p-ep-caption0)",
  placement="h")
```

(ref:p-ep-caption1) Post-hoc contrasts for group x session interaction.

```{r table-probe-excess1, echo=F}
apa_table(
  apa_emm1,
  caption="(ref:p-ep-caption1)",
  placement="h")
```

(ref:p-ep-caption2) Post-hoc contrasts for group x condition interaction.

```{r table-probe-excess2, echo=F}
apa_table(
  apa_emm2,
  caption="(ref:p-ep-caption2)",
  placement="h")
```

(ref:p-ep-caption3) Post-hoc contrasts for session x condition interaction.

```{r table-probe-excess3, echo=F}
apa_table(
  apa_emm3,
  caption="(ref:p-ep-caption3)",
  placement="h")
```

```{r, include=F}
rm(probe.excess_path_s, apa_lmm, apa_emm1, apa_emm2, apa_emm3)
```

\newpage 

### **Presence in outer alleys (vs. inner ring)** 

```{r, stats_probe_presence_alleys_simple}
```

```{r, plot_probe_presence_alleys, include=F }
```

```{r, echo=F, fig.height=5, fig.width=5, fig.cap="Relative presence in alleys in probe trials." }
line_presence_alleys
rm(line_presence_alleys)
```

```{r apa_probe_presence_alleys, include=F}
R2 <- r2beta(probe.presence_alleys_s$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(probe.presence_alleys_s)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

emm3 <- emmeans(probe.presence_alleys_s, ~ session * condition, lmer.df="satterthwaite")
con3 <- summary(rbind(pairs(emm3, simple="session"), pairs(emm3, simple="condition"), pairs(emm3, interaction="pairwise")), 
                infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm3 <- apa_print(con3)
apa_emm3 <- apa_emm3$table %>% remove_rownames()
rm(emm3, con3)
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

* *session x condition* interaction: only for allocentric condition significant change (decrease) in relative presence in outer alleys across sessions, but not for egocentric; the slopes differed between egocentric and allocentric (decrease across sessions).
* *condition* main effect: in egocentric trials relatively more time spend in outer alleys (compared to inner ring), whereas in allocentric trials more time spend in inner ring (compared to outer alleys).
* no *group* main effect and interactions, i.e. relative presence in alleys is not influences by age. 
(Table\ \@ref(tab:table-probe-presence0)). 

(ref:p-pa-caption0) Fixed effects for presence in probe trials.

```{r table-probe-presence0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:p-pa-caption0)",
  placement="h")
```

(ref:p-pa-caption3) Post-hoc contrasts for session x condition interaction.

```{r table-probe-presence3, echo=F}
apa_table(
  apa_emm3,
  caption="(ref:p-pa-caption3)",
  placement="h")
```

```{r, include=F}
rm(probe.presence_alleys_s, apa_lmm, apa_emm3)
```

\newpage

### **Initial rotation**

```{r, stats_probe_initial_rotation_simple }
```

```{r, plot_probe_initial_rotation, include=F }
```

```{r, echo=F, fig.height=5, fig.width=5, fig.cap="Initial rotation in probe trials." }
line_initial_rotation
rm(line_initial_rotation)
```

```{r apa_probe_initial_rotation, include=F }
R2 <- r2beta(probe.initial_rot_s$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(probe.initial_rot_s)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

emm4 <- emmeans(probe.initial_rot_s, ~ group*session*condition, lmer.df="satterthwaite")
con4 <- summary(rbind(pairs(emm4, simple="group"), pairs(emm4, simple="condition"), pairs(emm4, simple="session"), 
                      pairs(emm4, interaction="pairwise", by="condition")), infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm4 <- apa_print(con4)
apa_emm4 <- apa_emm4$table %>% remove_rownames()
rm(emm4, con4)
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

* *group x session x condition* interaction: In the allocentric condition both 6-7-yo children and adults had a significant increase in initial rotation across sessions (slope differed from zero) whereas this was not the case for 9-10-year-old children. In the egocentric condition there were no changes in initial rotation across sessions for all groups (slope did not differ from zero). For adults the increase in initial rotation across sessions was significantly larger for allocentric compared to egocentric, there was a trend for 6-7-year-old children. For adults the increase in initial rotation across session was significantly larger compared to 9-10-year-old children but not 6-7-year-old children.
* *group x condition* interaction and/or *condition* main effect: Initial rotation was higher in allocentric compared to egocentric.
(Table\ \@ref(tab:table-probe-init-rot0)). 

(ref:p-ir-caption0) Fixed effects for initial rotation in probe trials.

```{r table-probe-init-rot0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:p-ir-caption0)",
  placement="h")
```

(ref:p-ir-caption4) Post-hoc contrasts for group x session x condition interaction. 

```{r table-probe-init-rot4, echo=F}
apa_table(
  apa_emm4,
  caption="(ref:p-ir-caption4)",
  placement="h")
```

```{r, include=F}
rm(probe.initial_rot_s, apa_lmm, apa_emm4)
```

\newpage

### **Rotation by path length**

```{r, stats_probe_rotation_path_simple}
```

```{r, plot_probe_rotation_path, include=F }
```

```{r, echo=F, fig.height=5, fig.width=5, fig.cap="Normalized rotation in probe trials." }
line_rotation_path
rm(line_rotation_path)
```

```{r apa_probe_rotation_path, include=F}
R2 <- r2beta(probe.rotation_path_s$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(probe.rotation_path_s)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

emm1 <- emmeans(probe.rotation_path_s, ~ group * session, lmer.df="satterthwaite")
con1 <- summary(rbind(pairs(emm1, simple="group"), pairs(emm1, simple="session"), pairs(emm1, interaction="pairwise")), 
                infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm1 <- apa_print(con1)
apa_emm1 <- apa_emm1$table %>% remove_rownames()
rm(emm1, con1)

emm2 <- emmeans(probe.rotation_path_s, ~ group * condition, lmer.df="satterthwaite")
con2 <- summary(rbind(pairs(emm2, simple="group"), pairs(emm2, simple="condition")), infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm2 <- apa_print(con2)
apa_emm2 <- apa_emm2$table %>% remove_rownames()
rm(emm2, con2)

emm3 <- emmeans(probe.rotation_path_s, ~ session * condition, lmer.df="satterthwaite")
con3 <- summary(rbind(pairs(emm3, simple="session"), pairs(emm3, simple="condition"), pairs(emm3, interaction="pairwise")), 
                infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm3 <- apa_print(con3)
apa_emm3 <- apa_emm3$table %>% remove_rownames()
rm(emm3, con3)
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

* *group x session* interaction: for 6-7-year-old children and adults significant increase in rotation across sessions (slopes differed from zero) but not for 9-10-year-old children (although numerically present). The increase in rotation across sessions was significantly larger for adults compared to 9-10-year-old children. 
* *group x condition* interaction: all groups rotated significantly more in allocentric compared to egocentric trials; adults rotated significantly more than 6-7-year-old children in allocentric trials, whereas there were no group differences in rotation in egocentric trials (although trend for significantly more rotation in 6-7-year-old children compared to adults). 
* *session x condition* interaction: only for allocentric condition significant change (increase) in rotation across sessions, but not in egocentric; the slopes differed between egocentric (no change) and allocentric (increase).
(Table\ \@ref(tab:table-probe-rot0)). 

(ref:p-r-caption0) Fixed effects for normalized rotation in probe trials.

```{r table-probe-rot0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:p-r-caption0)",
  placement="h")
```

(ref:p-r-caption1) Post-hoc contrasts for group x session interaction.

```{r table-probe-rot1, echo=F}
apa_table(
  apa_emm1,
  caption="(ref:p-r-caption1)",
  placement="h")
```

(ref:p-r-caption2) Post-hoc contrasts for group x condition interaction.

```{r table-probe-rot2, echo=F}
apa_table(
  apa_emm2,
  caption="(ref:p-r-caption2)",
  placement="h")
```

(ref:p-r-caption3) Post-hoc contrasts for session x condition interaction.

```{r table-probe-rot3, echo=F}
apa_table(
  apa_emm3,
  caption="(ref:p-r-caption3)",
  placement="h")
```

```{r, include=F}
rm(probe.rotation_path_s, apa_lmm, apa_emm1, apa_emm2, apa_emm3)
```

\newpage 

## Explorative analyses of allocentric trials 

### Memory accuracy

**How often did participants erroneously pick locations that indicate an egocentric strategy** (only allocentric trials with defined egocentric location)

Chosen goal alley supposed to indicate the participant's navigation strategy: 

1. correct goal alley = allocentric, landmark-based 
1. egocentric alley = where the egocentric route leads to
3. other alley; serves as a baseline reference, defined as the maximum of those 3-4 other alleys that were not the goal and  egocentric alley (maximum instead of mean because mean induces downward bias for memory score)

Caution: this is exploratory and based on few trials! 

```{r, echo=F, fig.height=4 }
# box_allo_msa + theme(legend.position="bottom", legend.justification=c(0,0))
# rm(box_allo_msa)
```

### Navigation behavior

**How present were participants in specific zones that indicate strategies** (only allocentric trials where egocentric alley is not original start alley, egocentric response was available only for trials with defined egocentric location)

Presence in zones is supposed to indicate the participant's navigation strategy: 

1. start alley
2. goal alley 
3. original start alley
4. egocentric alley 
5. other alleys; serves as a baseline reference, defined as entering those alley(s) that were not the start, goal, original and egocentric alley (can be 1-3 alleys), either average, max or sum 

Caution: this is exploratory and based on few trials! 

```{r, echo=F, fig.height=4, fig.width=8}
# box_allo_pres + labs(subtitle="excluding triangle intersections") + 
#   box_allo_presT + labs(subtitle="including triangle intersections")+ 
#   plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0)) 
# rm(box_allo_pres, box_allo_presT)
```

\newpage 


## Appendix

\newpage 

### Memory score (all trials) with interactions with goal locations**

```{r, model_probe_ms_extended }
```

```{r, plot_probe_ms_extended, include=F }
```

```{r, echo=F, fig.height=7, fig.width=8, fig.cap="Memory score split for goal locations." }
plot.ms_ext
rm(plot.ms_ext)
```

```{r apa_probe_ms_extended, include=F}
R2 <- r2beta(model.ms_ext$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(model.ms_ext)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

# group x session x location 
emm1 <- emmeans(model.ms_ext, ~ group*cov_location*session, lmer.df="satterthwaite")
con1 <- summary(rbind(pairs(emm1, simple="group"), pairs(emm1, simple="session"), 
                      pairs(emm1, interaction="pairwise", by="cov_location")), infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm1 <- apa_print(con1)
apa_emm1 <- apa_emm1$table %>% remove_rownames() 
rm(emm1, con1)

# condition x location 
emm2 <- emmeans(model.ms_ext, ~ condition*cov_location, lmer.df="satterthwaite")
con2 <- summary(rbind(pairs(emm2, simple="condition"), pairs(emm2, simple="cov_location")), infer=c(T,T), by=NULL, adjust="bonferroni")
apa_emm2 <- apa_print(con2)
apa_emm2 <- apa_emm2$table %>% remove_rownames()
rm(emm2, con2)
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

* *group x session x location* interaction: 
* *condition x location* interaction: 
(Table\ \@ref(tab:table-probe-ex-ms0)). 

(ref:p-ex-ms-caption0) Fixed effects for memory score in probe (interactions with goal location).

```{r table-probe-ex-ms0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:p-ex-ms-caption0)",
  placement="h")
```

(ref:p-ex-ms-caption1) Post-hoc contrasts for group x session x location interaction.

```{r table-probe-ex-ms1, echo=F}
apa_table(
  apa_emm1,
  caption="(ref:p-ex-ms-caption1)",
  placement="h")
```

(ref:p-ex-ms-caption2) Post-hoc contrasts for condition x location interaction.

```{r table-probe-ex-ms2, echo=F}
apa_table(
  apa_emm2,
  caption="(ref:p-ex-ms-caption2)",
  placement="h")
```

```{r, include=F}
rm(model.ms_ext, R2, apa_lmm, apa_emm1, apa_emm2)
```

\newpage


### Correlations 

```{r, stats_corr_allo_ego_trad }
```

# ```{r, stats_corr_allo_ego_rmcorr }
# ```

\newpage

### PLS-C Analysis 

siehe Powerpoint Iryna 

### Navigation behavior: Training trials at Day 2 

#### **Time**

```{r, plot_learn_time, include=F}
```

```{r, echo=F, fig.height=4, fig.width=5, fig.cap="Trial curve for time in training." }
line_time 
rm(line_time)
```

```{r, stats_learn_time_simple }
```

```{r apa_learn_time, include=F}
R2 <- r2beta(learn.time_s$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(learn.time_s)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

emm <- emmeans(learn.time_s, pairwise ~ group, lmer.df="satterthwaite", adjust="bonferroni")$contrasts
apa_emm <- apa_print(emm) 
apa_emm <- apa_emm$table %>% remove_rownames()
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

The time per trial decreased across trials (main effect *trial in block*) but there were no group differences in the slope of the decrease (no interaction *group x trial in block interaction*). The groups differed in time per trial (main effect *group*). More specifically 6-7-year-old children were slower than 9-10-year-old children and adults, there were no differences between 9-10-year-old children and adults.
(Table\ \@ref(tab:table-learn-time0))

(ref:l-t-caption0) Fixed effects for time in training.

```{r table-learn-time0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:l-t-caption0)",
  placement="h")
# `r apa_lm$statistic$group`
```

(ref:l-t-caption1) Post-hoc contrasts for factor group.

```{r table-learn-time1, echo=F}
apa_table(
  apa_emm,
  caption="(ref:l-t-caption1)",
  placement="h")
```

```{r, include=F}
rm(learn.time_s, R2, apa_lmm, apa_emm, emm)
```

\newpage

#### **Excess path length**

```{r, plot_learn_excess_path, include=F}
```

```{r, echo=F, fig.height=4, fig.width=5, fig.cap="Trial curve for excess path in training." }
line_excess_path
rm(line_excess_path)
```

```{r, stats_learn_excess_path_simple }
```

```{r apa_learn_excess_path, include=F}
R2 <- r2beta(learn.excess_path_s$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(learn.excess_path_s)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

emm <- emmeans(learn.excess_path_s, pairwise ~ group, lmer.df="satterthwaite", adjust="bonferroni")$contrasts
apa_emm <- apa_print(emm) 
apa_emm <- apa_emm$table %>% remove_rownames()
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

The excess path length decreased across trials (main effect *trial in block*) but there were no group differences in the slope of the decrease (no interaction *group x trial in block* ). The groups differed in excess path length (main effect *group*). More specifically younger participants had longer excess paths, meaning they took less direct routes, compare to older participants (all groups differed from each other). 
(Table\ \@ref(tab:table-learn-excess0))

(ref:l-ep-caption0) Fixed effects for excess path length in training.

```{r table-learn-excess0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:l-ep-caption0)",
  placement="h")
```

(ref:l-ep-caption1) Post-hoc contrasts for factor group.

```{r table-learn-excess1, echo=F}
apa_table(
  apa_emm,
  caption="(ref:l-ep-caption1)",
  placement="h")
```

```{r, include=F}
rm(learn.excess_path_s, R2, apa_lmm, apa_emm, emm)
```

\newpage

#### **Presence in outer alleys (vs. inner ring)**

```{r, plot_learn_presence, include=F}
```

```{r, echo=F, fig.height=4, fig.width=5, fig.cap="Trial curve for relative presence in alleys in training." }
line_presence_alleys
rm(line_presence_alleys)
```

```{r, stats_learn_presence_simple }
```

```{r apa_learn_presence, include=F}
R2 <- r2beta(learn.presence_alleys_s$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(learn.presence_alleys_s)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

emm <- emmeans(learn.presence_alleys_s, pairwise ~ group, lmer.df="satterthwaite", adjust="bonferroni")$contrasts
apa_emm <- apa_print(emm) 
apa_emm <- apa_emm$table %>% remove_rownames()
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

Presence in the five outer alleys (relative to the inner ring) increased across trials, i.e. participant preferentially stayed in the outer alleys compared to the inner ring (main effect *trial in block*) but there were no group differences in the slope of the increase (no interaction *group x trial in block*). The groups differed in their relative presence in the outer alleys (main effect *group*). More specifically 6-7-year-old children spend relatively less time in the outer alleys (and more in the inner ring) than 9-10-year-old children and adults. There were no differences between 9-10-year-old children and adults. 
(Table\ \@ref(tab:table-learn-presence0))

(ref:l-pa-caption0) Fixed effects for presence in alleys in training.

```{r table-learn-presence0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:l-pa-caption0)",
  placement="h")
```

(ref:l-pa-caption1) Post-hoc contrasts for factor group.

```{r table-learn-presence1, echo=F}
apa_table(
  apa_emm,
  caption="(ref:l-pa-caption1)",
  placement="h")
```

```{r, include=F}
rm(learn.presence_alleys_s, R2, apa_lmm, apa_emm, emm)
```

\newpage

#### **Initial Rotation**

```{r, plot_learn_initial_rotation, include=F}
```

```{r,echo=F, fig.height=4, fig.width=5, fig.cap="Trial curve for initial rotation in training." }
line_initial_rotation
rm(line_initial_rotation)
```

```{r, stats_learn_initial_rotation_simple }
```

```{r apa_learn_initial_rotation, include=F}
R2 <- r2beta(learn.initial_rot_s$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(learn.initial_rot_s)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

emm <- emtrends(learn.initial_rot_s$full_model, pairwise ~ group, var="trial_in_block", lmer.df="satterthwaite", adjust="bonferroni")$contrasts
apa_emm <- apa_print(emm)
apa_emm <- apa_emm$table %>% remove_rownames()
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

Rotation in the initial area did not change generally across trials (no main effect *trial in block*) but there was an interaction *group x trial in block*. More specifically, adults had a stronger decrease in initial rotation across trials compared to 6-7-year-old children (who displayed no change). The slopes did not differ for any other group comparisons.
(Table\ \@ref(tab:table-learn-init-rot0))

(ref:l-ir-caption0) Post-hoc contrasts for group x trial in block interaction.

```{r table-learn-init-rot0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:l-ir-caption0)",
  placement="h")
```

(ref:l-ir-caption1) Post-hoc contrasts for group x trial in block interaction.

```{r table-learn-init-rot1, echo=F}
apa_table(
  apa_emm,
  caption="(ref:l-ir-caption1)",
  placement="h")
```

```{r, include=F}
rm(learn.initial_rot_s, R2, apa_lmm, apa_emm, emm)
```

\newpage

#### **Rotation normalized by path length**

```{r, plot_learn_rotation_path, include=F}
```

```{r, echo=F, fig.height=4, fig.width=5, fig.cap="Trial curve for normalized rotation in training." }
line_rotation_path 
rm(line_rotation_path)
```

```{r, stats_learn_rotation_path_simple }
```

```{r apa_learn_rotation_path, include=F}
R2 <- r2beta(learn.rotation_path_s$full_model, method='nsj', partial=F) %>% mutate_all(apa_num)

apa_lmm <- apa_print(learn.rotation_path_s)
apa_lmm <- apa_lmm$table %>% mutate(term=str_replace_all(term, c(" c| f"), ''))

emm <- emtrends(learn.rotation_path_s$full_model, pairwise ~ group, var="trial_in_block", lmer.df="satterthwaite", adjust="bonferroni")$contrasts
apa_emm <- apa_print(emm)
apa_emm <- apa_emm$table %>% remove_rownames()
```

The model had a fit of $R2 = `r R2$Rsq`, [CI: `r R2$upper.CL`, `r R2$lower.CL`$].

There was an interaction *group x trial in block* for the overall rotation (normalized by path length). More specifically, adults had a stronger decrease in rotation (normalized by path length) across trials compared to 6-7-year-old children and 9-10-year old children. The slopes did not differ between the two children groups.
(Table\ \@ref(tab:table-learn-rot0))

(ref:l-r-caption0) Fixed effects for normalized rotation in training.

```{r table-learn-rot0, echo=F}
apa_table(
  apa_lmm,
  caption="(ref:l-r-caption0)",
  placement="h")
```

(ref:l-r-caption1) Post-hoc contrasts for group x trial in block interaction.

```{r table-learn-rot1, echo=F}
apa_table(
  apa_emm,
  caption="(ref:l-r-caption1)",
  placement="h")
```

```{r, include=F}
rm(learn.rotation_path_s, R2, apa_lmm, apa_emm, emm)
```

\newpage 

### Motor Control Task 

![Motor control practise task](./pics/Motor_Control.jpg){width=600px}

```{r, echo=F, fig.height=6, fig.width=6, fig.cap="Navigation behavior in practise trials." }

mc_plot <- function(data, xvar, yvar, my_colors, my_labels, y_label){
  p <- ggplot(data, aes(x=get(xvar), y=get(yvar), color=get(xvar), shape=get(xvar))) + 
    stat_summary(fun.data=mean_cl_normal, na.rm=TRUE, geom="errorbar", width=0.2, size=1.5) +
    stat_summary(fun=mean, na.rm=TRUE, geom="point", size=3) +
    scale_color_manual(values=my_colors, labels=my_labels, name=NULL) +
    scale_shape(guide="none") +
    coord_cartesian(ylim=c(0,NA)) +
    theme_bw(base_size=15) +
    theme(legend.position="top", legend.justification=c(0,0),
          legend.title=NULL, 
          panel.grid.major.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.text.x=element_blank()) +
    labs(x=NULL, y=y_label, 
         caption="mean and 95% CI")
  
  return(p)
}

mc_time <- mc_plot(practise, "group", "excess_path_length", group_colors, group_labels, l_time)
mc_excess_path <- mc_plot(practise, "group", "time", group_colors, group_labels, l_excess_path_length)
mc_rotation <- mc_plot(practise, "group", "rotation_turns", group_colors, group_labels, l_rotation)
mc_rotation_path <- mc_plot(practise, "group", "rotation_turns_by_path_length", group_colors, group_labels, l_rotation_by_path)

mc_time + mc_excess_path + mc_rotation + mc_rotation_path + 
  plot_annotation("Navigation behavior in motor control task") + 
  plot_layout(guides="collect") & theme(legend.position="top", legend.justification=c(0,0))

rm(mc_time, mc_excess_path, mc_rotation, mc_rotation_path, mc_plot, practise)
```

### Excluded trials 

```{r, echo=F, fig.height=3, fig.width=3, fig.cap="Overview of excluded trials." }

excluded_trials <- sm_orig %>% 
  group_by(id, group) %>% 
  tally(exclude_trial_matlab)

ggplot(excluded_trials, aes(x=n, fill=group, color=group)) + 
  geom_histogram(binwidth=1) + 
  scale_fill_manual(labels=group_labels, values=group_colors) + 
  scale_color_manual(labels=group_labels, values=group_colors_o) +
  theme_bw(base_size=15) + 
  theme(legend.position=c(0.8,0.8),
        legend.key.size=unit(0.5, 'cm')) + 
  labs(subtitle="Number of excluded trials",
       x="n trials",
       y="n participants")

rm(excluded_trials)
```