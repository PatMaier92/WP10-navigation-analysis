---
title: "Preliminary Descriptives & Plots of Starmaze Data"
author: "Patrizia Maier"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

## Task

Navigating a star-shaped maze environment ("Starmaze") with three goal locations.

![Map of the environment](./pics/Starmaze_Environment.jpg){width=400px}

## Sessions

*Day 2*

* Practise trials, including joystick control practise (2 trials) and task explanation (5 trials).
* Navigation to and remembering of three goal locations. Baseline retrieval in egocentric (observer-dependent, i.e. from same starting point but without landmark cues) and allocentric (observer-independent, i.e. from new starting points) condition (15 trials * 3 goal locations = 45 trials).

*Day 14*

* Retrieval in egocentric and allocentric condition (5 trials * 3 locations = 15 trials).
* Post-navigation memory test: Recognize maze shape, recognize landmarks and goal objects, reconstruct location of landmarks and goal object (4 trials).

![Example view from task](./pics/Starmaze_01.png){width=500px}

![Trial order at Day 2 (45 trials)](./pics/Overview_Session1.jpg){width=500px}

![Trial order at Day 14 (15 trials)](./pics/Overview_Session2.jpg){width=500px}


```{r setup, include=FALSE, cache=FALSE}

library(tidyverse)
library(patchwork)
library(ggrepel)
# install.packages('tinytex')
# tinytex::install_tinytex() # latex for pdf file creation

knitr::read_chunk('Script_03_Plot_Creator.R')
knitr::read_chunk('Script_02_Analyzer.R')
```

```{r, analysis_packages_and_sum_coding, include=FALSE, cache=FALSE}
```

```{r, include=FALSE}
file_name <- "../WP10_data/WP10_results/wp10_navigation_data.RData"
load(file_name)
sm_orig <- sm_data 
sm_data <- sm_data %>% filter(exclude_trial_matlab==0)
rm(file_name)

file_name <- "../WP10_data/WP10_results/wp10_post_nav_data.RData"
load(file_name)
rm(file_name)
```

```{r, analysis_data, include=FALSE}
```

```{r, contrast_matrices, include=FALSE}
```

## Current sample
Cross-sectional comparison between

* Young kids (6-7 yrs, n = `r length(unique(sm_data$id[sm_data$group=="YoungKids"]))`) 
* Older kids (9-10 yrs, n = `r length(unique(sm_data$id[sm_data$group=="OldKids"]))`)
* Young adults (18-35 yrs, n = `r length(unique(sm_data$id[sm_data$group=="YoungAdults"]))`)


## Variables of interest

In learning trials, the goal is visible, i.e. the trial is always completed successfully except if the participant needs more than 120 seconds (time out). In egocentric and allocentric retrieval trials, the goal is not visible. Participants go to the place where they remember the goal being located and press a button. 

* **Correct goal alley** (yes/no): Finding the correct goal alley (x-/y-coordinates in correct outer arm or intersection right in front). 
* **Final distance** (metric): Distance between x-/y-coordinates of the chosen and the correct goal location. 
$$\text{Final distance} = \sqrt{(x_{correct}-x_{chosen})^2 + (y_{correct}-y_{chosen})^2}$$
* **Time**: Time to complete trial in seconds.
* **Path length (error)** (metric): Absolute deviation of travelled path length in relation to ideal path length. Calculated as summation of distance between x-/y-coordinates over time, then deviation of actual compared to ideal value (Caution: value can be misleading if chosen location is not correct location).
$$\text{Path length} = \sum \sqrt{(x_{t}-x_{t+1})^2 + (y_{t}-y_{t+1})^2}$$
$$\text{Path length error} = \frac {(path-path_{ideal})} {path_{ideal}}$$
* **Distance to location (error)** (metric): Absolute deviation of the cumulative distance to a location (e.g. goal, egocentric location) in relation to the ideal cumulative distance to the location (on the shortest possible path). Calculated as summation of distance between the player's x-/y-coordinates and the location's x-/y-coordinates, then averaged by the number of x-/y data points. 
$$\text{Distance to goal} = \frac {\sum \sqrt{(x_{t}-x_{goal})^2 + (y_{t}-y_{goal})^2}} {n_{t}}$$
$$\text{Distance to goal error} = \frac {(distance-distance_{ideal})} {distance_{ideal}}$$
* **Rotation** (turns normalized by path length): Sum of absolute z-rotations over time (takes into account switch at 0/360°) divided by 360° (i.e. full turns) and divided by path length (reason: longer paths automatically involve more rotation in a Starmaze environment, therefore normalized rotation is more indicative of exploration/looking-around). 
$$\text{Rotation} = \frac {\sum |(z_{t}-z_{t+1})|} {path} * \frac {1} {360} $$
* **Strategy classification**: Classification into three strategies: Direct to chosen goal, detour (entering more zones than necessary), or reorientation (re-entering same zones). 

![Examples for variables](./pics/Var_all.jpg){width=300px,height=500x}


``` {r, plot_settings, include=FALSE}
```

``` {r, plot_functions, include=FALSE}
```

\newpage

## Memory encoding: Learning curves at Day 1

```{r, plots_learning_trialwise, include=F }
```

```{r, warning=F, echo=F }

line_t + line_pler + line_dge + line_rpl + 
  plot_annotation("Navigation behaviour in learning trials (goal visible)") + 
  plot_layout(guides="collect") & theme(legend.position="top", legend.justification=c(0,0))

rm(line_t,line_pler, line_dge, line_rpl, sm_trialwise)
```
 
### **Time**

```{r, stats_learning_time }
```

### **Path length error**

```{r, stats_learning_pler }
```

### **Excess path length**

```{r, stats_learning_plex }
```

### **Distance to goal error**

```{r, stats_learning_dge }
```

### **Rotation (by path length)**

```{r, stats_learning_rpl }
```

\newpage 

## Immediate (Day 1) vs. consolidated retrieval (Day 13): Egocentric and allocentric condition 

```{r, plots_aggregated, include=F }
```

```{r, plots_aggregated_change, include=F }
```

```{r, plots_probe_locations, include=F }
```

### Accuracy 

**Raw data**

```{r, warning=F, echo=F, fig.height=5 }

dots_ego 

rm(dots_ego)
```

```{r, warning=F, echo=F, fig.height=5 }

dots_allo 

rm(dots_allo)
```

\newpage 

**Correct final alley**

```{r, warning=F, echo=F }

box_ego_cfa + labs(subtitle="Egocentric") + box_allo_cfa + labs(subtitle="Allocentric") +
  plot_annotation("Accuracy in probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_ego_cfa, box_allo_cfa)
```

```{r, stats_probe_acc }
```

```{r, warning=F, echo=F }

box_ego_delta_cfa + labs(subtitle="Egocentric") + box_allo_delta_cfa + labs(subtitle="Allocentric")  +
  plot_annotation("Change in accuracy in probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_ego_delta_cfa, box_allo_delta_cfa)
```

```{r, stats_probe_acc_change }
```

\newpage 

**Egocentric goal alley (in allocentric probe trials with outer starts only)**

```{r, warning=F, echo=F }

box_allo_efa + labs(subtitle="Allocentric")  +
  plot_annotation("Percentage where egocentric alley was chosen in allocentric probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_allo_efa, sm_agg2)
```

```{r, warning=F}

# How often did participants chose the egocentric alley?
temp1 <- data %>% filter(condition=="allo_ret", start_i %% 2==1)
table(temp1$correct_final_alley_ego, temp1$group)
temp1 %>% group_by(group) %>% summarise(mean(correct_final_alley_ego))
```

```{r, warning=F}
# If participants did not find the correct goal, how often did they chose the egocentric alley
temp2 <- data %>% filter(condition=="allo_ret", start_i %% 2==1, correct_final_alley==0)
table(temp2$correct_final_alley_ego, temp2$group)
temp2 %>% group_by(group) %>% summarise(mean(correct_final_alley_ego, na.rm=T))
```


\newpage 

**Final distance to goal (correct trials only)**

```{r, warning=F, echo=F }

box_ego_cor_fd + labs(subtitle="Egocentric") + box_allo_cor_fd + labs(subtitle="Allocentric") +
  plot_annotation("Final distance in correctly solved probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_ego_cor_fd, box_allo_cor_fd)
```

```{r, stats_probe_fd_in_corr }
```

\newpage 

**Memory score (all trials)**

```{r, warning=F, echo=F }

box_ego_ms + labs(subtitle="Egocentric") + box_allo_ms + labs(subtitle="Allocentric") +
  plot_annotation("Memory score in all probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_ego_ms, box_allo_ms)
```

```{r, stats_probe_ms }
```

```{r, warning=F, echo=F }

box_ego_delta_ms + labs(subtitle="Egocentric") + box_allo_delta_ms + labs(subtitle="Allocentric")  +
  plot_annotation("Change in memory score in probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_ego_delta_ms, box_allo_delta_ma)
```

```{r, stats_probe_ms_change }
```

\newpage 

**Final distance to egocentric (in allocentric probe trials with outer starts only)**

```{r, warning=F, echo=F }

box_allo_fde + labs(subtitle="Allocentric") +
  plot_annotation("Final distance to egocentric in allocentric probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_allo_fde)
```

```{r, stats_probe_fd_ego_in_allo }
```

\newpage

**Egocentric memory score (in allocentric probe trials with outer starts only)**

```{r, warning=F, echo=F }

box_allo_mse + labs(subtitle="Allocentric") +
  plot_annotation("Egocentric memory score in allocentric probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_allo_mse)
```

```{r, stats_probe_ms_ego_in_allo }
```

\newpage

### Navigation behaviour: metric variables

**Time**

```{r, warning=F, echo=F }

box_ego_t + labs(subtitle="Egocentric") + box_allo_t + labs(subtitle="Allocentric") +
  plot_annotation("Time in probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_ego_t, box_allo_t)
```

```{r, stats_probe_time}
```

\newpage 

**Path length error**

```{r, warning=F, echo=F }

box_ego_pler + labs(subtitle="Egocentric") + box_allo_pler + labs(subtitle="Allocentric") +
  plot_annotation("Path length error in probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_ego_pler, box_allo_pler)
```

```{r, stats_probe_pler}
```

\newpage 

**Excess path length**

```{r, warning=F, echo=F }

box_ego_cplex + labs(subtitle="Egocentric") + box_allo_cplex + labs(subtitle="Allocentric") +
  plot_annotation("Excess path length in probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_ego_cplex, box_allo_cplex)
```

```{r, stats_probe_chplex }
```

\newpage 

**Distance to goal error & distance to ego error** 

```{r, warning=F, echo=F }

box_ego_dge + labs(subtitle="Egocentric")  + 
  box_allo_dge + labs(subtitle="Allocentric") + 
  box_allo_dege + labs(subtitle="Allocentric") + 
  plot_annotation("Distance to goal error & distance to ego error in probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_ego_dge, box_allo_dge, box_allo_dege)
```

```{r, stats_probe_dge}
```

```{r, stats_probe_dge_ego_in_allo}
```

\newpage 

**Rotation and rotation by path length**

```{r, warning=F, echo=F }

box_ego_r + labs(subtitle="Egocentric") + box_allo_r + labs(subtitle="Allocentric") +
  plot_annotation("Rotation (full turns) in probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_ego_r, box_allo_r)
```

```{r, warning=F, echo=F }

box_ego_rpl + labs(subtitle="Egocentric") + box_allo_rpl + labs(subtitle="Allocentric") +
  plot_annotation("Relative rotation (full turns, normalized by path length) in probe trials") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(box_ego_rpl, box_allo_rpl)
rm(list=ls(pattern="agg"), sm_change)
```

```{r, stats_probe_rpl}
```

\newpage 

### Navigation behaviour: strategy use data 

```{r, plots_probe_strategy, include=F }
```

Strategies are a qualitative description of the trajector, independent of accuracy. For example, direct strategy means that the participant went straight to the chosen goal location without any detours or reorienting, independent of whether the chosen goal location was correct or incorrect. 

*Criteria for strategy assignment*:

* **Direct**: Shortest path to chosen goal location without re-entry of zones. Not necessarily correct goal location. 
* **Detour**: Non-direct path without re-entry of zones to chosen goal location. 
* **Reoriented**: Non-direct path with re-entry of zones to chosen goal location. 

![Examples for strategies](./pics/Overview_Strategies.jpg){width=300px}

```{r, warning=F, echo=F }

bar_ego_strategy + labs(subtitle="Egocentric") + bar_allo_strategy + labs(subtitle="Allocentric") +
  plot_annotation("Search strategy") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(bar_ego_strategy, bar_allo_strategy, sm_strategy)
```

\newpage 

## Correlations 

*TBD*

\newpage

## Post-navigational memory tasks

![Non-navigational memory retrieval at Day 14 (4 trials)](./pics/Overview_Session2_PostTest.jpg){width=500px}

```{r, plots_post_tests, include=F }
```

```{r, warning=F, echo=F }

layout + landmark_avg + gmda_avg + 
  plot_annotation("Post-navigational memory tests") + 
  plot_layout(width=c(0.4, 0.2, 0.2), guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

rm(layout, layout_avg, landmark_details, landmark_avg, gmda_avg)
```

### **Layout**

```{r, stats_layout }
```

### **Landmarks**
```{r, stats_landmark }
```

### **Positioning**
```{r, stats_gmda }
```

\newpage 

## Motor Control Task 

![Motor control practise task](./pics/Motor_Control.jpg){width=600px}

``` {r, plots_motor_control, include=FALSE}
```

```{r, warning=F, echo=F }

mc_t + mc_pl + mc_v + mc_r +
  plot_annotation("Motor control practise task") +
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

```

## Excluded trials 

``` {r, plots_excluded, include=FALSE}
```

```{r, warning=F, echo=F }

ex1 + ex2 +
  plot_annotation("Overview of excluded trial data") + 
  plot_layout(guides="collect") & theme(legend.position="bottom", legend.justification=c(0,0))

```

